<?xml version="1.0" standalone="no"?>
<!DOCTYPE model SYSTEM "xmml.dtd">
<model id="Canals" name="Canal system" xmml_version="0.4" xmlns="http://www.mapper-project.eu/xmml" xmlns:xi="http://www.w3.org/2001/XInclude" type="DAG">
    <description>
      A canal system in France, with possible floods or sedimentation.
    </description>

    <definitions>
      <xi:include href="isr_meta.xml#xpointer(/metadata/*)"/>
      
      <nestedmodel id="NESTED1" name="Nestedmodel1D" type="cyclic">
          <description>
              The nested-model example
          </description> 
          <definitions>
              <xi:include href="isr_meta.xml#xpointer(/metadata/*)"/>
              
          <submodel id="DD1D" name="DDCanal1D" type="Static">
	    <!--<timescale delta="10 min" total="1 yr"/>-->
	    <!--<spacescale id="x" delta="1 m" total="3 km"/>-->

             <ports>
               <in id="dd_flow_left_in" operator="S" datatype="double"/>
               <out id="dd_flow_right_out" operator="Oi" datatype="double"/>
             </ports>
           </submodel> 
	    <submodel id="EE1D" name="EECanal1D" init="yes">
             <timescale delta="10 min" total="1 yr"/>
             <spacescale id="x" delta="1 m" total="3 km"/>

             <ports>
               <in id="ee_flow_left_in" operator="S" datatype="double"/>
               <out id="ee_flow_right_out" operator="Oi" datatype="double"/>
             </ports>
           </submodel> 
	   <terminal id="inputns" type="source">
             <ports>
	       <in id="datain" datatype="double"/>
               <out id="dataout" datatype="double"/>
             </ports>
           </terminal>
           <terminal id="outputns" type="sink">
             <ports>
	       <in  id="datain" datatype="double"/>
               <out id="dataout" datatype="double"/>
             </ports>
           </terminal>
           </definitions>

	   <topology>
               <instance id="d1" submodel="DD1D">
                   <spacescale id="x" total="2 km"/>
               </instance>
	       <instance id="e1" submodel="EE1D">
                   <spacescale id="x" total="2 km"/>
               </instance>
	       <instance id="in1" submodel="inputns"/>
	       <instance id="out1" submodel="outputns"/>
	       <coupling from="in1.dataout" to="d1.ee_flow_left_in"/>
	       <coupling from="out1.datain" to="e1.ee_flow_right_out"/>
	     </topology>
      </nestedmodel>

      <submodel id="C1D" name="Canal1D" init="yes">
        <timescale delta="10 min" total="1 yr"/>
        <spacescale id="x" delta="1 m" total="3 km"/>

        <ports>
          <in id="flow_left_in" operator="S" datatype="double"/>
          <in id="flow_right_in" operator="S" datatype="double"/>
          <out id="flow_left_out" operator="Oi" datatype="double"/>
          <out id="flow_right_out" operator="Oi" datatype="double"/>
        </ports>
      </submodel>

      <submodel id="J" name="Junction">
        <timescale delta="10 min" total="1 yr"/>
        <spacescale delta="1 dm" total="3 m"/>

        <ports>
          <in id="flow_left_in" operator="S" datatype="double"/>
          <in id="flow_right_in" operator="S" datatype="double"/>
          <in id="flow_top_in" operator="S" datatype="double"/>
          <out id="flow_left_out" operator="Oi" datatype="double"/>
          <out id="flow_right_out" operator="Oi" datatype="double"/>
          <out id="flow_top_out" operator="Oi" datatype="double"/>
        </ports>
      </submodel>

      <submodel id="END" name="End point">
        <timescale delta="10 min" total="1 yr"/>
        <spacescale delta="1 dm" total="3 m"/>

        <ports>
          <in id="flow_in" operator="S" datatype="double"/>
          <out id="flow_out" operator="Oi" datatype="double"/>
        </ports>
      </submodel>
    </definitions>
  
  <topology>
    <instance id="c1" submodel="C1D">
      <spacescale id="x" total="2 km"/>
    </instance>
    <instance id="c2" submodel="C1D"/>
    <instance id="c3" submodel="C1D">
      <spacescale id="x" total="1 km"/>
    </instance>
    <instance id="src" submodel="END"/>
    <instance id="sink1" submodel="END"/>
    <instance id="sink2" submodel="END"/>
    <instance id="j" submodel="J"/>

    <coupling from="c1.flow_left_out" to="src.flow_in"/>
    <coupling from="c1.flow_left_in" to="src.flow_out"/>
    <coupling from="c1.flow_right_out" to="j.flow_left_in"/>
    <coupling from="c1.flow_right_in" to="j.flow_left_out"/>

    <coupling from="c2.flow_left_out" to="sink1.flow_in"/>
    <coupling from="c2.flow_left_in" to="sink1.flow_out"/>
    <coupling from="c2.flow_right_out" to="j.flow_right_in"/>
    <coupling from="c2.flow_right_in" to="j.flow_right_out"/>

    <coupling from="c3.flow_left_out" to="sink2.flow_in"/>
    <coupling from="c3.flow_left_in" to="sink2.flow_out"/>
    <coupling from="c3.flow_right_out" to="j.flow_top_in"/>
    <coupling from="c3.flow_right_in" to="j.flow_top_out"/>
    
    <coupling from="c1.flow_left_out" to="NESTED1.ns_flow_left_in"/>
    <coupling from="NESTED1.ns_flow_right_out" to="c2.flow_left_in"/>
  </topology>
</model>
